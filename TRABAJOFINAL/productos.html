<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gestión de Productos Profesional</title>
  <link rel="stylesheet" href="bootstrap-4.0.0-dist/css/bootstrap.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      background-color: #f0f2f5;
    }
    .navbar-custom {
      background-color: #343a40;
    }
    .navbar-custom .navbar-brand {
      color: #ffffff;
    }
    .stats-card {
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .table-custom thead {
      background-color: #495057;
      color: #fff;
    }
    .table-custom tbody tr:hover {
      background-color: #e9ecef;
    }
    .btn-custom-primary {
      background-color: #007bff;
      border-color: #007bff;
      color: #fff;
    }
    .btn-custom-primary:hover {
      background-color: #0056b3;
      border-color: #0056b3;
    }
    input[type="text"], input[type="number"] {
      width: 100%;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-custom mb-4">
    <a class="navbar-brand mx-auto" href="#">Panel de Productos</a>
  </nav>

  <div class="container">

    <!-- Tarjetas estadísticas -->
    <div class="row mb-4">
      <div class="col-md-4">
        <div class="card stats-card text-center p-3">
          <h6>Total Productos</h6>
          <h3 id="totalProductos">0</h3>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card stats-card text-center p-3">
          <h6>Productos Filtrados</h6>
          <h3 id="productosFiltrados">0</h3>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card stats-card text-center p-3">
          <h6>Valor Total Stock</h6>
          <h3 id="valorTotal">$0</h3>
        </div>
      </div>
    </div>

    <!-- Filtros -->
    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <form id="formFiltros" class="form-inline">
          <input type="text" id="buscar" class="form-control mx-2 mb-2" placeholder="Buscar producto">
          
          <select id="categoria" class="form-control mx-2 mb-2">
            <option value="todas">Todas categorías</option>
            <option>Electrónica</option>
            <option>Ropa</option>
            <option>Alimentos</option>
            <option>Hogar</option>
          </select>

          <input type="number" id="stockMinimo" class="form-control mx-2 mb-2" min="0" value="0" placeholder="Stock ≥">
          
          <select id="ordenar" class="form-control mx-2 mb-2">
            <option value="nombre_asc">Nombre (A-Z)</option>
            <option value="nombre_desc">Nombre (Z-A)</option>
            <option value="precio_asc">Precio ↓</option>
            <option value="precio_desc">Precio ↑</option>
            <option value="stock_asc">Stock ↓</option>
            <option value="stock_desc">Stock ↑</option>
          </select>

          <button type="button" id="aplicarFiltros" class="btn btn-custom-primary mb-2 mx-1">Aplicar</button>
          <button type="button" id="limpiarFiltros" class="btn btn-secondary mb-2 mx-1">Limpiar</button>
        </form>
      </div>
    </div>

    <!-- Formulario para agregar nuevo producto -->
    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Agregar Nuevo Producto</h5>
        <form id="formAgregar" class="form-row">
          <div class="form-group col-md-3">
            <input type="text" id="nuevoNombre" class="form-control" placeholder="Nombre" required>
          </div>
          <div class="form-group col-md-2">
            <input type="text" id="nuevaCategoria" class="form-control" placeholder="Categoría" required>
          </div>
          <div class="form-group col-md-2">
            <input type="number" id="nuevoPrecio" class="form-control" placeholder="Precio" required>
          </div>
          <div class="form-group col-md-2">
            <input type="number" id="nuevoStock" class="form-control" placeholder="Stock" required>
          </div>
          <div class="form-group col-md-3">
            <button type="submit" class="btn btn-success btn-block">Agregar Producto</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Tabla de productos -->
    <div class="table-responsive shadow-sm">
      <table class="table table-hover table-custom">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Categoría</th>
            <th>Precio</th>
            <th>Stock</th>
            <th>Valor Total</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody id="cuerpoTabla"></tbody>
      </table>
    </div>
  </div>

  <!-- JavaScript principal -->
  <script>
    let productosOriginales = [];
    let productosFiltrados = [];

    // Cargar productos desde PHP
    function cargarProductos() {
      fetch("obtener_productos.php")
        .then(res => res.json())
        .then(data => {
          productosOriginales = data;
          productosFiltrados = [...data];
          mostrarProductos(productosFiltrados);
        })
        .catch(error => console.error("Error al cargar productos:", error));
    }

    // Mostrar productos en la tabla
    function mostrarProductos(productos) {
      const cuerpo = document.getElementById("cuerpoTabla");
      cuerpo.innerHTML = "";

      if (productos.length === 0) {
        cuerpo.innerHTML = `<tr><td colspan="7" class="text-center text-danger">No hay productos para mostrar.</td></tr>`;
        return;
      }

      productos.forEach(producto => {
        const fila = document.createElement("tr");
        fila.innerHTML = `
          <td>${producto.id}</td>
          <td><input value="${producto.nombre}" onchange="editarCampo(${producto.id}, 'nombre', this.value)"></td>
          <td><input value="${producto.categoria}" onchange="editarCampo(${producto.id}, 'categoria', this.value)"></td>
          <td><input type="number" value="${producto.precio}" onchange="editarCampo(${producto.id}, 'precio', this.value)"></td>
          <td><input type="number" value="${producto.stock}" onchange="editarCampo(${producto.id}, 'stock', this.value)"></td>
          <td>$${(producto.precio * producto.stock).toFixed(2)}</td>
          <td><button class="btn btn-danger btn-sm" onclick="eliminarProducto(${producto.id})">Eliminar</button></td>
        `;
        cuerpo.appendChild(fila);
      });

      actualizarEstadisticas(productos);
    }

    // Actualizar estadísticas
    function actualizarEstadisticas(productos) {
      document.getElementById("totalProductos").textContent = productosOriginales.length;
      document.getElementById("productosFiltrados").textContent = productos.length;
      const valorTotal = productos.reduce((acum, p) => acum + p.valortotal, 0);
      document.getElementById("valorTotal").textContent = `$${valorTotal.toLocaleString()}`;
    }

    // Filtrar productos
    function aplicarFiltros() {
      const texto = document.getElementById("buscar").value.toLowerCase();
      const categoria = document.getElementById("categoria").value;
      const stockMinimo = parseInt(document.getElementById("stockMinimo").value);

      productosFiltrados = productosOriginales.filter(p => {
        const coincideNombre = p.nombre.toLowerCase().includes(texto);
        const coincideCategoria = categoria === "todas" || p.categoria === categoria;
        const cumpleStock = p.stock >= stockMinimo;
        return coincideNombre && coincideCategoria && cumpleStock;
      });

      ordenarProductos();
    }

    // Ordenar productos
    function ordenarProductos() {
      const criterio = document.getElementById("ordenar").value;
      productosFiltrados.sort((a, b) => {
        switch (criterio) {
          case "nombre_asc": return a.nombre.localeCompare(b.nombre);
          case "nombre_desc": return b.nombre.localeCompare(a.nombre);
          case "precio_asc": return a.precio - b.precio;
          case "precio_desc": return b.precio - a.precio;
          case "stock_asc": return a.stock - b.stock;
          case "stock_desc": return b.stock - a.stock;
          default: return 0;
        }
      });
      mostrarProductos(productosFiltrados);
    }

    // Limpiar filtros
    function limpiarFiltros() {
      document.getElementById("buscar").value = "";
      document.getElementById("categoria").value = "todas";
      document.getElementById("stockMinimo").value = 0;
      document.getElementById("ordenar").value = "nombre_asc";
      productosFiltrados = [...productosOriginales];
      mostrarProductos(productosFiltrados);
    }

    // Editar campo del producto (nombre, categoría, precio o stock)
    function editarCampo(id, campo, valor) {
      valor = valor.trim();

      if (campo === "precio" || campo === "stock") {
        valor = parseFloat(valor);
        if (isNaN(valor) || valor < 0) {
          alert("El valor ingresado no es válido.");
          cargarProductos(); // recarga para evitar dejar campo inválido
          return;
        }
      } else {
        if (!valor) {
          alert("El campo no puede estar vacío.");
          cargarProductos(); // recarga para evitar dejar campo vacío
          return;
        }
      }

      const producto = productosFiltrados.find(p => p.id === id);
      const actualizado = { ...producto, [campo]: valor };

      fetch("editarProducto.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(actualizado)
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          cargarProductos();
        } else {
          alert("Error al actualizar: " + (data.error || ""));
        }
      });
    }


    // Eliminar producto
    function eliminarProducto(id) {
      if (!confirm("¿Estás seguro de eliminar este producto?")) return;

      fetch("eliminarProducto.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          cargarProductos();
        } else {
          alert("Error al eliminar.");
        }
      });
    }

    // Agregar producto nuevo
    document.getElementById("formAgregar").addEventListener("submit", function(e) {
      e.preventDefault();

      const nombreRaw = document.getElementById("nuevoNombre").value;
      const nombre = nombreRaw.trim().toLowerCase();
      const categoria = document.getElementById("nuevaCategoria").value.trim();
      const precio = parseFloat(document.getElementById("nuevoPrecio").value);
      const stock = parseInt(document.getElementById("nuevoStock").value);

      if (!nombre || !categoria || isNaN(precio) || precio <= 0 || isNaN(stock) || stock < 0) {
        alert("Por favor, completa todos los campos correctamente.");
        return;
      }

      // Validación cliente para evitar nombres duplicados
      const existeNombre = productosOriginales.some(p => p.nombre.toLowerCase() === nombre);
      if (existeNombre) {
        alert("Ya existe un producto con ese nombre. Por favor, elige otro.");
        return;
      }

      fetch("insertarProducto.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nombre: nombreRaw.trim(), categoria, precio, stock })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          document.getElementById("formAgregar").reset();
          cargarProductos();
        } else {
          alert(data.error || "Error al agregar producto");
        }
      })
      .catch(() => {
        alert("Error de comunicación con el servidor");
      });
    });



    // Eventos de botones de filtros
    document.getElementById("aplicarFiltros").addEventListener("click", aplicarFiltros);
    document.getElementById("limpiarFiltros").addEventListener("click", limpiarFiltros);

    // Cargar productos al iniciar
    cargarProductos();
  </script>
</body>
</html>
